<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 450">
  <defs>
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#1a1a2e"/>
      <stop offset="100%" style="stop-color:#16213e"/>
    </linearGradient>
    
    <linearGradient id="inputGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#667eea"/>
      <stop offset="100%" style="stop-color:#764ba2"/>
    </linearGradient>
    
    <linearGradient id="outputGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#43e97b"/>
      <stop offset="100%" style="stop-color:#38f9d7"/>
    </linearGradient>
    
    <linearGradient id="nnGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#f093fb"/>
      <stop offset="100%" style="stop-color:#f5576c"/>
    </linearGradient>
    
    <filter id="glow">
      <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
    
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#667eea"/>
    </marker>
    
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#43e97b"/>
    </marker>
    
    <marker id="arrowPink" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f5576c"/>
    </marker>
  </defs>
  
  <rect width="900" height="450" fill="url(#bgGrad)"/>
  
  <!-- Title -->
  <text x="450" y="35" text-anchor="middle" font-family="system-ui" font-size="24" font-weight="700" fill="white">
    Coupling Layer Architecture
  </text>
  <text x="450" y="58" text-anchor="middle" font-family="system-ui" font-size="13" fill="rgba(255,255,255,0.6)">
    The key building block of modern normalizing flows (RealNVP, Glow)
  </text>
  
  <!-- Main Diagram -->
  <g transform="translate(450, 240)">
    
    <!-- Input vector z split -->
    <g transform="translate(-350, 0)">
      <text y="-110" text-anchor="middle" font-family="system-ui" font-size="14" font-weight="600" fill="white">Input z</text>
      
      <!-- z vector box -->
      <rect x="-40" y="-90" width="80" height="180" rx="6" fill="rgba(102,126,234,0.2)" stroke="#667eea" stroke-width="2"/>
      
      <!-- z1 (unchanged) -->
      <rect x="-35" y="-85" width="70" height="80" rx="4" fill="rgba(102,126,234,0.3)" stroke="#667eea" stroke-width="1"/>
      <text y="-40" text-anchor="middle" font-family="system-ui" font-size="16" font-weight="600" fill="#a5b4fc">z₁</text>
      <text y="-20" text-anchor="middle" font-family="monospace" font-size="10" fill="rgba(255,255,255,0.5)">(unchanged)</text>
      
      <!-- z2 (transformed) -->
      <rect x="-35" y="5" width="70" height="80" rx="4" fill="rgba(240,147,251,0.3)" stroke="#f5576c" stroke-width="1"/>
      <text y="50" text-anchor="middle" font-family="system-ui" font-size="16" font-weight="600" fill="#fda4af">z₂</text>
      <text y="70" text-anchor="middle" font-family="monospace" font-size="10" fill="rgba(255,255,255,0.5)">(transformed)</text>
    </g>
    
    <!-- Arrow from z1 to NN -->
    <path d="M -270,-45 Q -200,-45 -200,-45 L -130,-45" stroke="#667eea" stroke-width="2" fill="none" marker-end="url(#arrowBlue)"/>
    
    <!-- Neural Network Box -->
    <g transform="translate(-80, -45)">
      <rect x="-50" y="-55" width="100" height="110" rx="8" fill="rgba(240,147,251,0.15)" stroke="#f5576c" stroke-width="2"/>
      
      <!-- NN layers -->
      <g fill="#f5576c" opacity="0.6">
        <rect x="-35" y="-40" width="70" height="8" rx="2"/>
        <rect x="-35" y="-25" width="70" height="8" rx="2"/>
        <rect x="-35" y="-10" width="70" height="8" rx="2"/>
        <rect x="-35" y="5" width="70" height="8" rx="2"/>
        <rect x="-35" y="20" width="70" height="8" rx="2"/>
        <rect x="-35" y="35" width="70" height="8" rx="2"/>
      </g>
      
      <text y="70" text-anchor="middle" font-family="system-ui" font-size="12" font-weight="600" fill="#f5576c">Neural Net</text>
      <text y="85" text-anchor="middle" font-family="monospace" font-size="10" fill="rgba(255,255,255,0.5)">s(z₁), t(z₁)</text>
    </g>
    
    <!-- NN outputs s and t -->
    <g transform="translate(80, -45)">
      <!-- Scale output -->
      <path d="M -50,-30 L 0,-30" stroke="#feca57" stroke-width="2" fill="none"/>
      <circle cx="15" cy="-30" r="15" fill="rgba(254,202,87,0.2)" stroke="#feca57" stroke-width="2"/>
      <text x="15" y="-25" text-anchor="middle" font-family="monospace" font-size="14" font-weight="600" fill="#feca57">s</text>
      
      <!-- Translation output -->
      <path d="M -50,30 L 0,30" stroke="#54a0ff" stroke-width="2" fill="none"/>
      <circle cx="15" cy="30" r="15" fill="rgba(84,160,255,0.2)" stroke="#54a0ff" stroke-width="2"/>
      <text x="15" y="35" text-anchor="middle" font-family="monospace" font-size="14" font-weight="600" fill="#54a0ff">t</text>
    </g>
    
    <!-- Transformation operation -->
    <g transform="translate(180, 45)">
      <!-- z2 input -->
      <path d="M -490,0 Q -400,0 -300,0 L -50,0" stroke="#f5576c" stroke-width="2" fill="none" stroke-dasharray="5,3"/>
      
      <!-- Multiply with s -->
      <path d="M -85,-75 L -30,-20" stroke="#feca57" stroke-width="2" fill="none"/>
      
      <!-- Add t -->
      <path d="M -85,-15 L -30,15" stroke="#54a0ff" stroke-width="2" fill="none"/>
      
      <!-- Operation circle -->
      <circle cx="0" cy="0" r="25" fill="rgba(67,233,123,0.2)" stroke="#43e97b" stroke-width="2"/>
      <text y="5" text-anchor="middle" font-family="monospace" font-size="12" font-weight="600" fill="#43e97b">⊙+</text>
      
      <text y="45" text-anchor="middle" font-family="monospace" font-size="11" fill="rgba(255,255,255,0.6)">y₂ = z₂ ⊙ exp(s) + t</text>
    </g>
    
    <!-- Output vector -->
    <g transform="translate(350, 0)">
      <text y="-110" text-anchor="middle" font-family="system-ui" font-size="14" font-weight="600" fill="white">Output y</text>
      
      <!-- y vector box -->
      <rect x="-40" y="-90" width="80" height="180" rx="6" fill="rgba(67,233,123,0.2)" stroke="#43e97b" stroke-width="2"/>
      
      <!-- y1 = z1 -->
      <rect x="-35" y="-85" width="70" height="80" rx="4" fill="rgba(102,126,234,0.3)" stroke="#667eea" stroke-width="1"/>
      <text y="-40" text-anchor="middle" font-family="system-ui" font-size="16" font-weight="600" fill="#a5b4fc">y₁</text>
      <text y="-20" text-anchor="middle" font-family="monospace" font-size="10" fill="rgba(255,255,255,0.5)">= z₁</text>
      
      <!-- y2 = transformed -->
      <rect x="-35" y="5" width="70" height="80" rx="4" fill="rgba(67,233,123,0.3)" stroke="#43e97b" stroke-width="1"/>
      <text y="50" text-anchor="middle" font-family="system-ui" font-size="16" font-weight="600" fill="#86efac">y₂</text>
      <text y="70" text-anchor="middle" font-family="monospace" font-size="10" fill="rgba(255,255,255,0.5)">= z₂⊙eˢ+t</text>
    </g>
    
    <!-- Connection: y1 = z1 (straight pass-through on top) -->
    <path d="M -270,-45 Q -200,-130 200,-130 Q 270,-130 270,-45" stroke="#667eea" stroke-width="2" fill="none" stroke-dasharray="8,4" marker-end="url(#arrowBlue)"/>
    <text x="0" y="-140" text-anchor="middle" font-family="monospace" font-size="11" fill="#667eea">identity (pass-through)</text>
    
    <!-- Connection: y2 -->
    <path d="M 205,45 L 260,45" stroke="#43e97b" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
  </g>
  
  <!-- Key Properties Box -->
  <g transform="translate(450, 400)">
    <rect x="-400" y="-30" width="350" height="70" rx="8" fill="rgba(67,233,123,0.1)" stroke="#43e97b" stroke-width="1"/>
    
    <text x="-380" y="-5" font-family="system-ui" font-size="12" font-weight="600" fill="#43e97b">✓ Key Properties:</text>
    <text x="-380" y="15" font-family="system-ui" font-size="11" fill="rgba(255,255,255,0.7)">• Jacobian is triangular → det is product of diagonal</text>
    <text x="-380" y="32" font-family="system-ui" font-size="11" fill="rgba(255,255,255,0.7)">• Invertible: z₂ = (y₂ - t) ⊙ exp(-s)</text>
    
    <rect x="10" y="-30" width="390" height="70" rx="8" fill="rgba(240,147,251,0.1)" stroke="#f5576c" stroke-width="1"/>
    
    <text x="30" y="-5" font-family="system-ui" font-size="12" font-weight="600" fill="#f5576c">Log-Determinant:</text>
    <text x="30" y="20" font-family="monospace" font-size="14" fill="#fda4af">log|det(∂y/∂z)| = Σᵢ sᵢ(z₁)</text>
    <text x="30" y="38" font-family="system-ui" font-size="10" fill="rgba(255,255,255,0.5)">Sum of scale outputs (no matrix inversion needed!)</text>
  </g>
</svg>

